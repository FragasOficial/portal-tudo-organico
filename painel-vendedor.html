<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Vendedor - Tudo Org√¢nico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Painel do Vendedor</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <main class="container">
    <h2>üìä Estat√≠sticas do Vendedor</h2>
    <div class="dashboard">
      <div class="card"><h3>üõçÔ∏è Total de Produtos Cadastrados</h3><p id="totalProductsCount">0</p></div>
      <div class="card"><h3>üì¶ Pedidos Recebidos</h3><p id="totalSellerOrders">0</p></div>
      <div class="card"><h3>üí∞ Total Faturado</h3><p id="totalRevenue">R$ 0,00</p></div>
      <div class="card"><h3>üèÜ Produto Mais Vendido</h3><p id="bestSellingProduct">N/A</p></div>
      <div class="card"><h3>‚≠ê Avalia√ß√£o M√©dia</h3><p id="averageRating">0.0</p></div>
    </div>
  </main>

  <section style="margin-top: 2em;">
    <h2>üìà Gr√°fico de Vendas por Produto (Exemplo - Precisa de dados reais da API)</h2>
    <canvas id="graficoVendas" width="400" height="200"></canvas>
  </section>

  <section style="margin-top: 2em;" class="form-container">
    <h2>‚ûï Adicionar Novo Produto</h2>
    <form id="productForm">
      <label for="name">Nome do Produto:</label>
      <input type="text" id="name" required />

      <label for="nutritionalInfo">Tabela Nutricional:</label>
      <textarea id="nutritionalInfo" rows="4" placeholder="Ex: Calorias, prote√≠nas, fibras..."></textarea>


      <label for="price">Pre√ßo (R$):</label>
      <input type="number" id="price" step="0.01" required />

      <label for="imageUrl">Imagem (URL):</label>
      <input type="url" id="imageUrl" required />

      <label for="state">Estado (UF):</label>
      <select id="state" required>
        <option value="">Selecione</option>
      </select>

      <label for="city">Cidade:</label>
      <select id="city" required>
        <option value="">Selecione</option>
      </select>

      <button type="submit">Adicionar Produto</button>
    </form>
  </section>

  <section style="margin-top: 2em;">
    <h2>üì¶ Meus Produtos</h2>
    <div id="myProductsList" class="product-grid">
      </div>
  </section>

  <script src="estados-cidades.js"></script>
  <script>
    const API_URL = "http://localhost:3000/api";
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    const token = localStorage.getItem("authToken");

    // Redireciona se n√£o for vendedor ou n√£o estiver logado
    if (!currentUser || currentUser.accountType !== "vendedor" || !token) {
      alert("Acesso restrito aos vendedores. Por favor, fa√ßa login.");
      location.href = "login.html";
    }

    function logout() {
      localStorage.removeItem("authToken");
      localStorage.removeItem("currentUser");
      location.href = "login.html";
    }

    // Popula filtros de estado/cidade para o formul√°rio de adicionar produto
    function populateLocationFilters() {
      const stateSelect = document.getElementById("state");
      const citySelect = document.getElementById("city");

      for (let uf in estadosCidades) {
        stateSelect.innerHTML += `<option value="${uf}">${uf}</option>`;
      }

      stateSelect.addEventListener("change", () => {
        const uf = stateSelect.value;
        citySelect.innerHTML = '<option value="">Selecione</option>';
        if (uf && estadosCidades[uf]) {
          estadosCidades[uf].forEach(city => {
            citySelect.innerHTML += `<option value="${city}">${city}</option>`;
          });
        }
      });
    }

    // Carregar produtos do vendedor da API
    async function loadMyProducts() {
      try {
        const response = await fetch(`${API_URL}/products`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        const products = await response.json();
        // Filtra os produtos para mostrar apenas os do vendedor logado
        const myProducts = products.filter(p => p.vendedorId === currentUser.id);
        renderMyProducts(myProducts);
        updateDashboardStats(myProducts); // Atualiza stats com base nos produtos
      } catch (err) {
        console.error("Erro ao carregar seus produtos:", err);
        document.getElementById("myProductsList").innerHTML = "<p>Erro ao carregar seus produtos.</p>";
      }
    }

    function renderMyProducts(products) {
      const container = document.getElementById("myProductsList");
      container.innerHTML = "";
      if (products.length === 0) {
        container.innerHTML = "<p>Voc√™ n√£o possui produtos cadastrados.</p>";
        return;
      }

      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product-card";
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" />
          <h4>${p.name}</h4>
          <p>R$ ${p.price.toFixed(2)}</p>
          <p>${p.city}/${p.state}</p>
          <button onclick="deleteProduct(${p.id})">Excluir</button>
        `;
        container.appendChild(div);
      });
    }

    // Deletar produto via API
    async function deleteProduct(id) {
      if (!confirm("Tem certeza que deseja excluir este produto?")) {
        return;
      }
      try {
        const response = await fetch(`${API_URL}/products/${id}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        if (response.ok) {
          alert("Produto exclu√≠do com sucesso.");
          loadMyProducts(); // Recarrega a lista
        } else {
          const errorData = await response.json();
          alert(`Erro ao excluir produto: ${errorData.message || response.statusText}`);
        }
      } catch (err) {
        console.error("Erro ao excluir produto:", err);
        alert("Erro de conex√£o ao excluir produto.");
      }
    }

    // Adicionar produto via API
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const body = {
        name: document.getElementById("name").value,
        price: parseFloat(document.getElementById("price").value),
        image: document.getElementById("imageUrl").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        nutritionalInfo: document.getElementById("nutritionalInfo").value
      };



      try {
        const response = await fetch(`${API_URL}/products`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          alert("Produto cadastrado com sucesso!");
          e.target.reset(); // Limpa o formul√°rio
          loadMyProducts(); // Recarrega a lista de produtos
        } else {
          const errorData = await response.json();
          alert(`Erro ao cadastrar produto: ${errorData.message || response.statusText}`);
        }
      } catch (err) {
        console.error("Erro ao cadastrar produto:", err);
        alert("Erro de conex√£o ao cadastrar produto.");
      }
    });

    // Fun√ß√£o para atualizar as estat√≠sticas do dashboard (ainda sem dados reais da API para todos)
    async function updateDashboardStats(myProducts) {
        document.getElementById("totalProductsCount").textContent = myProducts.length;

        try {
            const ordersResponse = await fetch(`${API_URL}/orders/seller`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const sellerOrders = await ordersResponse.json();

            document.getElementById("totalSellerOrders").textContent = sellerOrders.length;

            let totalRevenue = 0;
            const productSales = {}; // Para o produto mais vendido e gr√°fico
            sellerOrders.forEach(item => {
                const subtotal = item.quantity * item.unitPrice; // unitPrice agora
                totalRevenue += subtotal;
                productSales[item.productName] = (productSales[item.productName] || 0) + item.quantity;
            });
            document.getElementById("totalRevenue").textContent = `R$ ${totalRevenue.toFixed(2)}`;

            // Calcular produto mais vendido
            let bestProduct = "N/A";
            let maxSales = 0;
            for (const prodName in productSales) {
                if (productSales[prodName] > maxSales) {
                    maxSales = productSales[prodName];
                    bestProduct = prodName;
                }
            }
            document.getElementById("bestSellingProduct").textContent = bestProduct;

            // Avalia√ß√£o m√©dia (precisa de uma rota /api/products/average-rating ou calcular no frontend)
            // Por enquanto, fica est√°tico ou simulado
            document.getElementById("averageRating").textContent = "4.5 (Simulado)"; // Placeholder

            // Gr√°fico de vendas (exemplo, precisa de dados reais)
            const ctx = document.getElementById('graficoVendas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(productSales),
                    datasets: [{
                        label: 'Quantidade Vendida',
                        data: Object.values(productSales),
                        backgroundColor: 'rgba(46, 125, 50, 0.6)',
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });


        } catch (error) {
            console.error("Erro ao carregar estat√≠sticas do vendedor:", error);
            // Mostrar mensagens de erro nos cards ou deixar como "N/A"
        }
    }


    // Inicializa ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      populateLocationFilters();
      loadMyProducts();
    });
  </script>
  <script>
  // üîê Segredo tempor√°rio para testes ‚Äî deve ser igual ao do backend
  const secret = 'seuSegredoJWT123';

  // Gera novo token se n√£o houver um ou se estiver expirado
  function gerarTokenJWTTeste() {
    // Verificar se j√° existe token v√°lido
    const tokenExistente = localStorage.getItem("token");

    if (tokenExistente) {
      try {
        const payload = JSON.parse(atob(tokenExistente.split('.')[1]));
        const exp = payload.exp * 1000;
        const agora = Date.now();

        if (exp > agora) {
          console.log("‚úÖ Token ainda v√°lido");
          return;
        } else {
          console.warn("‚ö†Ô∏è Token expirado. Ser√° gerado novo.");
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è Token inv√°lido. Ser√° gerado novo.");
      }
    }

    // Payload fixo para testes
    const payload = {
      id: 1,
      email: "sfptc06@gmail.com",
      accountType: "vendedor",
      iat: Math.floor(Date.now() / 1000),
      exp: Math.floor(Date.now() / 1000) + 60 * 60 * 12 // 12h
    };

    // Fun√ß√£o para codificar em base64url
    function base64url(source) {
      return btoa(JSON.stringify(source))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }

    // Header
    const header = {
      alg: "HS256",
      typ: "JWT"
    };

    const unsignedToken = `${base64url(header)}.${base64url(payload)}`;

    // ‚ö†Ô∏è Simula assinatura ‚Äî apenas para testes (N√ÉO seguro em produ√ß√£o!)
    async function gerarAssinaturaFake() {
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw",
        encoder.encode(secret),
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
      );
      const assinatura = await crypto.subtle.sign("HMAC", key, encoder.encode(unsignedToken));
      const hashArray = Array.from(new Uint8Array(assinatura));
      const assinaturaB64 = btoa(String.fromCharCode(...hashArray))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
      return assinaturaB64;
    }

    gerarAssinaturaFake().then(signature => {
      const token = `${unsignedToken}.${signature}`;
      localStorage.setItem("token", token);
      console.log("‚úÖ Novo token JWT gerado e salvo:", token);
    });
  }

  gerarTokenJWTTeste();
</script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Vendedor - Tudo Org√¢nico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Painel do Vendedor</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <main class="container">
    <h2>üìä Estat√≠sticas do Vendedor</h2>
    <div class="dashboard">
      <div class="card"><h3>üõçÔ∏è Total de Produtos Cadastrados</h3><p id="totalProductsCount">0</p></div>
      <div class="card"><h3>üì¶ Pedidos Recebidos</h3><p id="totalSellerOrders">0</p></div>
      <div class="card"><h3>üí∞ Total Faturado</h3><p id="totalRevenue">R$ 0,00</p></div>
      <div class="card"><h3>üèÜ Produto Mais Vendido</h3><p id="bestSellingProduct">N/A</p></div>
      <div class="card"><h3>‚≠ê Avalia√ß√£o M√©dia</h3><p id="averageRating">0.0</p></div>
    </div>
  </main>

  <section style="margin-top: 2em;">
    <h2>üìà Gr√°fico de Vendas por Produto</h2>
    <canvas id="graficoVendas" width="400" height="200"></canvas>
  </section>

  <section style="margin-top: 2em;" class="form-container">
    <h2>‚ûï Adicionar Novo Produto</h2>
    <form id="productForm">
      <label for="name">Nome do Produto:</label>
      <input type="text" id="name" required />

      <label for="nutritionalInfo">Tabela Nutricional:</label>
      <textarea id="nutritionalInfo" rows="4" placeholder="Ex: Calorias, prote√≠nas, fibras..."></textarea>

      <label for="price">Pre√ßo (R$):</label>
      <input type="number" id="price" step="0.01" required />

      <label for="imageUrl">Imagem (URL):</label>
      <input type="url" id="imageUrl" required />

      <label for="state">Estado (UF):</label>
      <select id="state" required>
        <option value="">Selecione</option>
      </select>

      <label for="city">Cidade:</label>
      <select id="city" required>
        <option value="">Selecione</option>
      </select>

      <button type="submit">Adicionar Produto</button>
    </form>
  </section>

  <section style="margin-top: 2em;">
    <h2>üì¶ Meus Produtos</h2>
    <div id="myProductsList" class="product-grid"></div>
  </section>

  <script src="estados-cidades.js"></script>
  <script>
    const API_URL = "http://localhost:3000/api";
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    const token = localStorage.getItem("authToken");

    // Redireciona se n√£o for vendedor ou n√£o estiver logado
    if (!currentUser || currentUser.accountType !== "vendedor" || !token) {
      alert("Acesso restrito aos vendedores. Por favor, fa√ßa login.");
      location.href = "login.html";
    }

    function logout() {
      localStorage.removeItem("authToken");
      localStorage.removeItem("currentUser");
      location.href = "login.html";
    }

    function populateLocationFilters() {
      const stateSelect = document.getElementById("state");
      const citySelect = document.getElementById("city");

      for (let uf in estadosCidades) {
        stateSelect.innerHTML += `<option value="${uf}">${uf}</option>`;
      }

      stateSelect.addEventListener("change", () => {
        const uf = stateSelect.value;
        citySelect.innerHTML = '<option value="">Selecione</option>';
        if (uf && estadosCidades[uf]) {
          estadosCidades[uf].forEach(city => {
            citySelect.innerHTML += `<option value="${city}">${city}</option>`;
          });
        }
      });
    }

    async function loadMyProducts() {
      try {
        const response = await fetch(`${API_URL}/products`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const products = await response.json();
        const myProducts = products.filter(p => p.vendedorId === currentUser.id);
        renderMyProducts(myProducts);
        updateDashboardStats(myProducts);
      } catch (err) {
        console.error("Erro ao carregar seus produtos:", err);
        document.getElementById("myProductsList").innerHTML = "<p>Erro ao carregar seus produtos.</p>";
      }
    }

    function renderMyProducts(products) {
      const container = document.getElementById("myProductsList");
      container.innerHTML = "";
      if (products.length === 0) {
        container.innerHTML = "<p>Voc√™ n√£o possui produtos cadastrados.</p>";
        return;
      }

      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product-card";
        div.innerHTML = `
          <img src="${p.image}" alt="${p.name}" />
          <h4>${p.name}</h4>
          <p>R$ ${p.price.toFixed(2)}</p>
          <p>${p.city}/${p.state}</p>
          <button onclick="deleteProduct(${p.id})">Excluir</button>
        `;
        container.appendChild(div);
      });
    }

    async function deleteProduct(id) {
      if (!confirm("Tem certeza que deseja excluir este produto?")) return;

      try {
        const response = await fetch(`${API_URL}/products/${id}`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (response.ok) {
          alert("Produto exclu√≠do com sucesso.");
          loadMyProducts();
        } else {
          const errorData = await response.json();
          alert(`Erro ao excluir produto: ${errorData.message || response.statusText}`);
        }
      } catch (err) {
        console.error("Erro ao excluir produto:", err);
        alert("Erro de conex√£o ao excluir produto.");
      }
    }

    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const body = {
        name: document.getElementById("name").value,
        price: parseFloat(document.getElementById("price").value),
        image: document.getElementById("imageUrl").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        nutritionalInfo: document.getElementById("nutritionalInfo").value
      };

      try {
        const response = await fetch(`${API_URL}/products`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          alert("Produto cadastrado com sucesso!");
          e.target.reset();
          loadMyProducts();
        } else {
          const errorData = await response.json();
          alert(`Erro ao cadastrar produto: ${errorData.message || response.statusText}`);
        }
      } catch (err) {
        console.error("Erro ao cadastrar produto:", err);
        alert("Erro de conex√£o ao cadastrar produto.");
      }
    });

    async function updateDashboardStats(myProducts) {
      document.getElementById("totalProductsCount").textContent = myProducts.length;

      try {
        const ordersResponse = await fetch(`${API_URL}/orders/seller`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const sellerOrders = await ordersResponse.json();

        document.getElementById("totalSellerOrders").textContent = sellerOrders.length;

        let totalRevenue = 0;
        const productSales = {};
        sellerOrders.forEach(item => {
          const subtotal = item.quantity * item.unitPrice;
          totalRevenue += subtotal;
          productSales[item.productName] = (productSales[item.productName] || 0) + item.quantity;
        });
        document.getElementById("totalRevenue").textContent = `R$ ${totalRevenue.toFixed(2)}`;

        let bestProduct = "N/A";
        let maxSales = 0;
        for (const prodName in productSales) {
          if (productSales[prodName] > maxSales) {
            maxSales = productSales[prodName];
            bestProduct = prodName;
          }
        }
        document.getElementById("bestSellingProduct").textContent = bestProduct;
        document.getElementById("averageRating").textContent = "4.5 (Simulado)";

        const ctx = document.getElementById('graficoVendas').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(productSales),
            datasets: [{
              label: 'Quantidade Vendida',
              data: Object.values(productSales),
              backgroundColor: 'rgba(46, 125, 50, 0.6)',
              borderColor: 'rgba(46, 125, 50, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: { y: { beginAtZero: true } }
          }
        });
      } catch (error) {
        console.error("Erro ao carregar estat√≠sticas do vendedor:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      populateLocationFilters();
      loadMyProducts();
    });
  </script>
</body>
</html>
