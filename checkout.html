<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Tudo Org√¢nico</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <main class="form-container">
    <h2>Finalizar Compra</h2>
    <div id="checkoutSummary"></div>

    <h3>Forma de Pagamento</h3>
    <form id="paymentForm">
      <label><input type="radio" name="payment" value="credito" required /> Cart√£o de Cr√©dito</label><br/>
      <label><input type="radio" name="payment" value="debito" /> Cart√£o de D√©bito</label><br/>
      <label><input type="radio" name="payment" value="pix" /> PIX</label><br/>
      <label><input type="radio" name="payment" value="dinheiro" /> Dinheiro / Retirar no Local</label><br/><br/>

      <button type="submit">Finalizar Pedido</button>
    </form>

    <div id="receipt" class="hidden"></div>
  </main>

  <script>
    document.getElementById("finalizarCompra").addEventListener("click", () => {
    const user = JSON.parse(localStorage.getItem("currentUser"));
    const cart = JSON.parse(localStorage.getItem("cart") || "{}");
    const allPurchases = JSON.parse(localStorage.getItem("purchases") || "[]");
    const products = JSON.parse(localStorage.getItem("products") || "[]");

    const items = [];
    let total = 0;

    const vendedoresInfo = {};

    for (const key in cart) {
        const item = cart[key];
        const vendedor = products.find(p => p.id === item.product.id);
        const vEmail = vendedor.vendedorEmail;

        if (!vendedoresInfo[vEmail]) {
        vendedoresInfo[vEmail] = {
            endereco: vendedor.vendedorEndereco || "Endere√ßo n√£o informado",
            telefone: vendedor.vendedorTelefone || "Telefone n√£o informado",
            produtos: [],
        };
        }

        vendedoresInfo[vEmail].produtos.push({
        nome: item.product.name,
        quantidade: item.quantity,
        preco: item.product.price,
        });

        items.push({
        id: item.product.id,
        name: item.product.name,
        price: item.product.price,
        quantity: item.quantity
        });

        total += item.product.price * item.quantity;
    }

    const purchase = {
        userEmail: user.email,
        items,
        total,
        date: Date.now()
    };

    allPurchases.push(purchase);
    localStorage.setItem("purchases", JSON.stringify(allPurchases));
    localStorage.removeItem("cart");

    // Gera√ß√£o do recibo
    let reciboHTML = `<p><strong>Cliente:</strong> ${user.email}</p>`;
    reciboHTML += `<p><strong>Data:</strong> ${new Date().toLocaleString()}</p>`;

    for (const vendedor in vendedoresInfo) {
        const dados = vendedoresInfo[vendedor];
        reciboHTML += `<hr><p><strong>Vendedor:</strong> ${vendedor}</p>`;
        reciboHTML += `<p><strong>Endere√ßo:</strong> ${dados.endereco}</p>`;
        reciboHTML += `<p><strong>Telefone:</strong> ${dados.telefone}</p>`;
        reciboHTML += `<ul>`;
        dados.produtos.forEach(p => {
        reciboHTML += `<li>${p.nome} - ${p.quantidade} x R$ ${p.preco.toFixed(2)} = R$ ${(p.quantidade * p.preco).toFixed(2)}</li>`;
        });
        reciboHTML += `</ul>`;
    }

    reciboHTML += `<h3>Total da compra: R$ ${total.toFixed(2)}</h3>`;

    document.getElementById("conteudoRecibo").innerHTML = reciboHTML;
    document.getElementById("recibo").style.display = "block";

    // Gerar o PDF automaticamente
    html2pdf().from(document.getElementById("recibo")).save("recibo_tudo_organico.pdf");

    setTimeout(() => {
        alert("Compra finalizada com sucesso!");
        window.location.href = "historico.html";
    }, 1000);
    });

    const cart = JSON.parse(localStorage.getItem("checkoutCart") || "[]");
    const users = Object.keys(localStorage)
      .filter(key => key.startsWith("user_"))
      .map(key => JSON.parse(localStorage.getItem(key)));

    const sellersInCart = {};

    cart.forEach(item => {
      const seller = users.find(u => u.accountType === "vendedor" && u.city === item.city && u.state === item.state);
      const sellerKey = seller?.email || "desconhecido";

      if (!sellersInCart[sellerKey]) {
        sellersInCart[sellerKey] = {
          seller,
          items: [],
          total: 0
        };
      }

      const subtotal = item.qty * item.price;
      sellersInCart[sellerKey].items.push(item);
      sellersInCart[sellerKey].total += subtotal;
    });

    const summaryDiv = document.getElementById("checkoutSummary");
    let totalCompra = 0;
    summaryDiv.innerHTML = "";

    for (const key in sellersInCart) {
      const section = document.createElement("div");
      const v = sellersInCart[key];
      const contato = v.seller ? `
        <p><strong>Vendedor:</strong> ${v.seller.firstName} ${v.seller.lastName}</p>
        <p><strong>Endere√ßo:</strong> ${v.seller.address}</p>
        <p><strong>Telefone:</strong> ${v.seller.phone}</p>
        <p><strong>Cidade/UF:</strong> ${v.seller.city}/${v.seller.state}</p>
        <p><strong>Entrega:</strong> Gr√°tis at√© 5 km (simulado)</p>
      ` : "<p><em>Vendedor n√£o identificado</em></p>";

      const listaProdutos = v.items.map(item => `<li>${item.name} x${item.qty} = R$ ${(item.qty * item.price).toFixed(2)}</li>`).join("");

      totalCompra += v.total;

      section.innerHTML = `
        <hr/>
        ${contato}
        <ul>${listaProdutos}</ul>
        <p><strong>Subtotal: R$ ${v.total.toFixed(2)}</strong></p>
      `;
      summaryDiv.appendChild(section);
    }

    const totalEl = document.createElement("p");
    totalEl.innerHTML = `<strong>Total da Compra: R$ ${totalCompra.toFixed(2)}</strong>`;
    summaryDiv.appendChild(totalEl);

    document.getElementById("paymentForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const paymentType = document.querySelector("input[name='payment']:checked").value;
      const receipt = document.getElementById("receipt");

      let message = `<h3>Recibo de Compra</h3><p>Forma de pagamento: <strong>${paymentType.toUpperCase()}</strong></p>`;
      message += summaryDiv.innerHTML;

      if (paymentType === "dinheiro") {
        message += `<p><strong>Pagamento em esp√©cie no local</strong>. Leve o valor exato e retire com o vendedor.</p>`;
      } else {
        message += `<p><strong>Pagamento digital simulado</strong>. (Fict√≠cio)</p>`;
      }

      receipt.innerHTML = message;
      receipt.classList.remove("hidden");

      // Envio simulado de e-mail ao vendedor (console)
      for (const key in sellersInCart) {
        const seller = sellersInCart[key].seller;
        if (seller) {
          console.log(`üìß E-mail enviado para ${seller.email}: Nova compra! Total: R$ ${sellersInCart[key].total.toFixed(2)}`);
        }
      }

      localStorage.removeItem("checkoutCart"); // Limpa carrinho
    });

    // Prepara carrinho vindo do modal/cart
    if (!cart.length) {
      alert("Seu carrinho est√° vazio.");
      window.location.href = "index.html";
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
<script>
  async function calcularDistancia(origem, destino, callback) {
    const service = new google.maps.DistanceMatrixService();

    service.getDistanceMatrix(
      {
        origins: [origem],
        destinations: [destino],
        travelMode: google.maps.TravelMode.DRIVING
      },
      (response, status) => {
        if (status === "OK") {
          const distanceText = response.rows[0].elements[0].distance.text;
          const distanceValue = response.rows[0].elements[0].distance.value / 1000; // km
          callback(distanceValue, distanceText);
        } else {
          console.error("Erro ao calcular dist√¢ncia:", status);
          callback(null, "Erro");
        }
      }
    );
  }

  function renderEntregaParaCadaVendedor(clienteEndereco) {
    for (const key in sellersInCart) {
      const vendedor = sellersInCart[key].seller;
      const index = Object.keys(sellersInCart).indexOf(key);
      const section = document.querySelectorAll("#checkoutSummary > div")[index];

      if (!vendedor) continue;

      calcularDistancia(clienteEndereco, vendedor.address, (km, texto) => {
        let entregaTexto = "";
        if (km <= 5 || vendedor.freeDelivery) {
            entregaTexto = `Entrega gr√°tis (${texto})`;
            } else {
            entregaTexto = `Entrega com taxa (dist√¢ncia: ${texto})`;
            }
      });
    }
  }

  // Exemplo de endere√ßo do cliente (simulado)
  const clienteEndereco = JSON.parse(localStorage.getItem("currentUser"))?.address || "S√£o Paulo, SP";

  // Aguarda carregamento do Maps antes de iniciar c√°lculo
  window.addEventListener("load", () => {
    renderEntregaParaCadaVendedor(clienteEndereco);
  });

  document.getElementById("finalizarCompra").addEventListener("click", () => {
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const cart = JSON.parse(localStorage.getItem("cart") || "{}");
  const allPurchases = JSON.parse(localStorage.getItem("purchases") || "[]");

  const items = [];
  let total = 0;

  for (const key in cart) {
    const item = cart[key];
    items.push({
      id: item.product.id,
      name: item.product.name,
      price: item.product.price,
      quantity: item.quantity
    });
    total += item.product.price * item.quantity;
  }

  const purchase = {
    userEmail: user.email,
    items,
    total,
    date: Date.now()
  };

  allPurchases.push(purchase);
  localStorage.setItem("purchases", JSON.stringify(allPurchases));
  localStorage.removeItem("cart");

  alert("Compra finalizada com sucesso!");
  window.location.href = "historico.html";
});
</script>
<div id="recibo" style="display:none; background:#fff; padding:20px; font-size:14px;">
  <h2>Recibo de Compra - Tudo Org√¢nico</h2>
  <div id="conteudoRecibo"></div>
</div>
</body>
</html>
